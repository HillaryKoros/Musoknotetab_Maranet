{% extends 'base.html' %}
{% load static %}
{% load leaflet_tags %}

{% block title %}Map Viewer{% endblock %}

{% block content %}
<div class="sidebar">
    <div class="layer-control">
        <h4>Layers</h4>
        <div id="overlay-layers"></div>

        <div class="basemap-section">
            <h4>Base Maps</h4>
            <div id="basemap-layers"></div>
        </div>
    </div>
    <button id="generate-report" class="btn btn-primary">Generate Report</button>
    <div class="legend" id="legend"></div>
</div>

<div id="map"></div>

<style>
    #map {
        position: absolute;
        top: 60px;
        right: 0;
        bottom: 0;
        width: calc(100% - 300px);
        height: calc(100vh - 60px);
    }

    .sidebar {
        position: absolute;
        top: 60px;
        left: 0;
        width: 300px;
        height: calc(100vh - 60px);
        background: white;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        z-index: 1000;
    }

    .layer-control {
        padding: 20px;
    }

    .layer-item {
        margin: 10px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 5px;
        cursor: pointer;
    }

    .layer-item:hover {
        background: #e9e9e9;
    }

    .layer-item label {
        cursor: pointer;
    }

    .legend {
        padding: 10px;
        background: white;
        border-radius: 5px;
        margin: 20px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
</style>

<script type="text/javascript" src="{% static 'dist/leaflet.ajax.js' %}"></script>
<script>
    const LAYER_CONFIGS = {
        'Affected Population': {
            url: "{% url 'affectedPop' %}",
            popupTitle: "Population Data"
        },
        'Affected Crops': {
            url: "{% url 'affectedCrops' %}",
            popupTitle: "Crops Data"
        },
        'Affected GDP': {
            url: "{% url 'affectedGDP' %}",
            popupTitle: "GDP Data"
        },
        'Affected GrazingLand': {
            url: "{% url 'affectedGrazingLand' %}",
            popupTitle: "Grazing Data"
        },
        'Displaced Population': {
            url: "{% url 'displacedPop' %}",
            popupTitle: "Displaced Population Data"
        },
        'Affected Roads': {
            url: "{% url 'affectedRoads' %}",
            popupTitle: "Affected Roads Data"
        },
        'Affected Livestock': {
            url: "{% url 'affectedLivestock' %}",
            popupTitle: "Affected Livestock Data"
        }
    };

    const BASE_MAPS = {
        'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }),
        'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri'
        }),
        'Terrain': L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
            attribution: '© Stamen Design'
        })
    };

    const breaks = [0, 1, 5, 10, 15, 20];

    function getFloodColor(flood_tot) {
        return flood_tot > 15 ? '#f86c31' :
               flood_tot > 10 ? '#fda649' :
               flood_tot > 5  ? '#fed66d' :
               flood_tot > 1  ? '#ffffb2' :
                              '#ffffff';
    }

    function style(feature) {
        const flood_tot = feature.properties.flood_tot;
        const baseStyle = {
            weight: 2,
            opacity: 1,
            color: '#666',
            dashArray: '0.3'
        };

        return flood_tot === 0 ? {
            ...baseStyle,
            fillColor: 'none',
            fillOpacity: 0
        } : {
            ...baseStyle,
            fillColor: getFloodColor(flood_tot),
            fillOpacity: 0.7
        };
    }

    function createPopupContent(feature, title) {
        let popupContent = `<h3>${title}:</h3><ul>`;
        for (let property in feature.properties) {
            popupContent += `<li><strong>${property}:</strong> ${feature.properties[property]}</li>`;
        }
        return popupContent + "</ul>";
    }

    function updateLegend(activeLayerName) {
        const legendDiv = document.getElementById('legend');
        if (!activeLayerName) {
            legendDiv.innerHTML = '<h4>No layer selected</h4>';
            return;
        }

        legendDiv.innerHTML = `<h4>${activeLayerName}</h4>`;
        for (let i = 1; i < breaks.length; i++) {
            legendDiv.innerHTML +=
                '<i style="background:' + getFloodColor(breaks[i]) + '"></i> ' +
                breaks[i - 1] + (breaks[i] ? '&ndash;' + breaks[i] + '<br>' : '+');
        }
    }

    function createLayerControl(layerName, layer, container, isBasemap = false) {
        const div = document.createElement('div');
        div.className = 'layer-item';
        
        const input = document.createElement('input');
        input.type = isBasemap ? 'radio' : 'checkbox';
        input.name = isBasemap ? 'basemap' : 'overlay';
        input.id = layerName;
        
        const label = document.createElement('label');
        label.htmlFor = layerName;
        label.textContent = layerName;
        
        div.appendChild(input);
        div.appendChild(label);
        container.appendChild(div);

        return { input, div };
    }

    function out_layers(map, options) {
        // Initialize basemaps
        const basemapContainer = document.getElementById('basemap-layers');
        Object.entries(BASE_MAPS).forEach(([name, layer], index) => {
            const { input } = createLayerControl(name, layer, basemapContainer, true);
            if (index === 0) {
                layer.addTo(map);
                input.checked = true;
            }
            input.addEventListener('change', () => {
                Object.values(BASE_MAPS).forEach(l => map.removeLayer(l));
                layer.addTo(map);
            });
        });

        // Initialize overlay layers
        const overlayContainer = document.getElementById('overlay-layers');
        const layers = {};

        Object.entries(LAYER_CONFIGS).forEach(([name, config]) => {
            layers[name] = new L.GeoJSON.AJAX(config.url, {
                style: style,
                onEachFeature: (feature, layer) => {
                    if (feature.properties) {
                        layer.bindPopup(createPopupContent(feature, config.popupTitle));
                    }
                }
            });

            const { input } = createLayerControl(name, layers[name], overlayContainer);
            
            input.addEventListener('change', () => {
                if (input.checked) {
                    map.addLayer(layers[name]);
                    updateLegend(name);
                } else {
                    map.removeLayer(layers[name]);
                    updateLegend('');
                }
            });
        });

        // Add default layer
        const defaultLayer = 'Affected Population';
        layers[defaultLayer].addTo(map);
        document.getElementById(defaultLayer).checked = true;
        updateLegend(defaultLayer);
    }
</script>

{% leaflet_map "map" callback="window.out_layers" %}
{% endblock %}